<!doctype html>
<html>
  <head>
    <title>PDF Extraction Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 50px auto;
        padding: 20px;
      }
      .test-section {
        margin: 20px 0;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .error {
        background-color: #fee;
        color: #c00;
        padding: 10px;
        border-radius: 3px;
        margin: 10px 0;
      }
      .success {
        background-color: #efe;
        color: #060;
        padding: 10px;
        border-radius: 3px;
        margin: 10px 0;
      }
      button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background-color: #0056b3;
      }
      pre {
        background-color: #f5f5f5;
        padding: 10px;
        border-radius: 3px;
        overflow-x: auto;
      }
    </style>
  </head>
  <body>
    <h1>üß™ PDF Extraction Test</h1>
    <p>Test PDF text extraction with different scenarios</p>

    <div class="test-section">
      <h2>Test 1: Upload Real PDF</h2>
      <p>Upload a PDF file to test the extraction:</p>
      <input type="file" id="pdfFile" accept=".pdf" />
      <button onclick="testPDFExtraction()">Test Extraction</button>
      <div id="result1"></div>
    </div>

    <div class="test-section">
      <h2>Test 2: Simulated Scanned PDF (Empty Text)</h2>
      <button onclick="testScannedPDF()">Test Scanned PDF Error</button>
      <div id="result2"></div>
    </div>

    <div class="test-section">
      <h2>Test 3: Edge Function Direct Call</h2>
      <button onclick="testEdgeFunction()">Test Edge Function</button>
      <div id="result3"></div>
    </div>

    <script>
      const SUPABASE_URL = "https://cqvufndxjakdbmbjhwlx.supabase.co";
      const ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNxdnVmbmR4amFrZGJtYmpod2x4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2MDAwNzMsImV4cCI6MjA3MDE3NjA3M30.pGmQIWmrTODu1r2cWuOzr9W0hre7eHblU2q9OWPZXPk";

      async function testPDFExtraction() {
        const fileInput = document.getElementById("pdfFile");
        const resultDiv = document.getElementById("result1");

        if (!fileInput.files.length) {
          resultDiv.innerHTML =
            '<div class="error">Please select a PDF file first</div>';
          return;
        }

        const file = fileInput.files[0];
        resultDiv.innerHTML = "<p>Processing " + file.name + "...</p>";

        try {
          // Read file as base64
          const reader = new FileReader();
          reader.onload = async (e) => {
            const arrayBuffer = e.target.result;
            const uint8Array = new Uint8Array(arrayBuffer);

            // Convert to base64
            let binaryString = "";
            for (let i = 0; i < uint8Array.length; i += 8192) {
              const chunk = uint8Array.slice(i, i + 8192);
              let chunkStr = "";
              for (let j = 0; j < chunk.length; j++) {
                chunkStr += String.fromCharCode(chunk[j]);
              }
              binaryString += chunkStr;
            }
            const base64 = btoa(binaryString);

            // Test Edge Function
            const response = await fetch(
              `${SUPABASE_URL}/functions/v1/analyze-contract`,
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  apikey: ANON_KEY,
                  Authorization: `Bearer ${ANON_KEY}`,
                },
                body: JSON.stringify({
                  content: `PDF_FILE_BASE64:${base64}`,
                  reviewType: "full_summary",
                  model: "openai-gpt-4",
                  fileName: file.name,
                }),
              },
            );

            const responseText = await response.text();

            if (response.ok) {
              const result = JSON.parse(responseText);
              resultDiv.innerHTML = `
                            <div class="success">‚úÖ Success!</div>
                            <p><strong>Score:</strong> ${result.score}%</p>
                            <p><strong>Confidence:</strong> ${(result.confidence * 100).toFixed(0)}%</p>
                            <p><strong>Summary:</strong> ${result.summary || result.executive_summary || "N/A"}</p>
                            <pre>${JSON.stringify(result, null, 2)}</pre>
                        `;
            } else {
              const error = JSON.parse(responseText);
              resultDiv.innerHTML = `
                            <div class="error">‚ùå Error ${response.status}</div>
                            <p><strong>Message:</strong> ${error.error || error.message || responseText}</p>
                            ${error.technical_details ? `<p><strong>Technical:</strong> ${error.technical_details}</p>` : ""}
                            <pre>${responseText}</pre>
                        `;
            }
          };
          reader.readAsArrayBuffer(file);
        } catch (error) {
          resultDiv.innerHTML = `<div class="error">‚ùå ${error.message}</div>`;
        }
      }

      async function testScannedPDF() {
        const resultDiv = document.getElementById("result2");
        resultDiv.innerHTML = "<p>Testing scanned PDF scenario...</p>";

        try {
          // Create a minimal "empty" PDF that will fail text extraction
          const emptyPDFBase64 =
            "JVBERi0xLjQKJcfsj6IKNSAwIG9iago8PC9MZW5ndGggNiAwIFI+PgpzdHJlYW0KZW5kc3RyZWFtCmVuZG9iago2IDAgb2JqCjAKZW5kb2JqCnhyZWYKMCA3CjAwMDAwMDAwMDAgNjU1MzUgZiAKdHJhaWxlcgo8PC9TaXplIDcvUm9vdCA0IDAgUi9JbmZvIDMgMCBSPj4Kc3RhcnR4cmVmCjU2MwolJUVPRgo=";

          const response = await fetch(
            `${SUPABASE_URL}/functions/v1/analyze-contract`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                apikey: ANON_KEY,
                Authorization: `Bearer ${ANON_KEY}`,
              },
              body: JSON.stringify({
                content: `PDF_FILE_BASE64:${emptyPDFBase64}`,
                reviewType: "full_summary",
                model: "openai-gpt-4",
                fileName: "scanned.pdf",
              }),
            },
          );

          const responseText = await response.text();

          resultDiv.innerHTML = `
                    <div class="${response.ok ? "error" : "success"}">
                        ${response.ok ? "‚ùå Expected error but got success" : "‚úÖ Correctly returned error"}
                    </div>
                    <p><strong>Status:</strong> ${response.status}</p>
                    <p><strong>Response:</strong></p>
                    <pre>${responseText}</pre>
                `;
        } catch (error) {
          resultDiv.innerHTML = `<div class="error">‚ùå ${error.message}</div>`;
        }
      }

      async function testEdgeFunction() {
        const resultDiv = document.getElementById("result3");
        resultDiv.innerHTML =
          "<p>Testing Edge Function with text contract...</p>";

        const testContract = `
NON-DISCLOSURE AGREEMENT

This Agreement is made between Company A and Company B.

1. CONFIDENTIALITY
The parties agree to maintain confidentiality of all shared information.

2. TERM
This agreement shall remain in effect for 2 years.
            `.trim();

        try {
          const response = await fetch(
            `${SUPABASE_URL}/functions/v1/analyze-contract`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                apikey: ANON_KEY,
                Authorization: `Bearer ${ANON_KEY}`,
              },
              body: JSON.stringify({
                content: testContract,
                reviewType: "full_summary",
                model: "openai-gpt-4",
                fileName: "test-nda.txt",
              }),
            },
          );

          const responseText = await response.text();
          const result = JSON.parse(responseText);

          resultDiv.innerHTML = `
                    <div class="success">‚úÖ Success!</div>
                    <p><strong>Score:</strong> ${result.score}%</p>
                    <p><strong>Model:</strong> ${result.model_used}</p>
                    <p><strong>Fallback Used:</strong> ${result.fallback_used ? "Yes" : "No"}</p>
                    ${result.fallback_reason ? `<p><strong>Fallback Reason:</strong> ${result.fallback_reason}</p>` : ""}
                    <pre>${JSON.stringify(result, null, 2)}</pre>
                `;
        } catch (error) {
          resultDiv.innerHTML = `<div class="error">‚ùå ${error.message}</div>`;
        }
      }
    </script>
  </body>
</html>
